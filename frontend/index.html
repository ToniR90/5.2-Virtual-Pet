<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Pet - Tu Mascota Digital</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* === LOGIN/REGISTER SCREEN === */
        .login-screen {
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            min-height: 100vh;
            background-image: url('images/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            padding: 40px;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-card h1 {
            margin-bottom: 30px;
            color: #4a5568;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            outline: none;
        }

        .form-group input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }

        /* === DASHBOARD SCREEN === */
        .dashboard {
            display: none;
            padding: 40px 0;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header h1 {
            color: #4a5568;
            font-size: 2rem;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .pet-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pet-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .pet-image {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .pet-image img {
            width: 100px;
            height: 100px;
            object-fit: contain;
        }

        .pet-info h3 {
            margin-bottom: 10px;
            color: #4a5568;
            font-size: 1.4rem;
        }

        .pet-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #718096;
        }

        .create-pet-card {
            border: 3px dashed #cbd5e0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px;
        }

        .create-pet-card:hover {
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.9);
        }

        .create-icon {
            font-size: 3rem;
            color: #cbd5e0;
            margin-bottom: 15px;
        }

        /* === PET DETAIL SCREEN === */
        .pet-detail {
            display: none;
            padding: 40px 0;
        }

        .pet-detail.active {
            display: block;
        }

        .pet-detail-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .pet-detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .back-btn {
            background: #e2e8f0;
            color: #4a5568;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .pet-detail-image {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pet-detail-image img {
            width: 180px;
            height: 180px;
            object-fit: contain;
        }

        .pet-name {
            font-size: 2.5rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .pet-stage {
            font-size: 1.2rem;
            color: #718096;
            margin-bottom: 30px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-bar {
            text-align: left;
        }

        .stat-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .stat-progress {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .stat-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.3s ease;
        }

        .stat-energy .stat-fill { background: linear-gradient(90deg, #48bb78, #68d391); }
        .stat-happiness .stat-fill { background: linear-gradient(90deg, #ed8936, #f6ad55); }
        .stat-hunger .stat-fill { background: linear-gradient(90deg, #e53e3e, #fc8181); }
        .stat-experience .stat-fill { background: linear-gradient(90deg, #667eea, #764ba2); }

        .actions-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .action-btn {
            padding: 15px 20px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-2px);
        }

        .btn-feed {
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
        }

        .btn-play {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
        }

        .btn-rest {
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
        }

        .btn-ignore {
            background: linear-gradient(135deg, #a0aec0, #cbd5e0);
            color: #4a5568;
        }

        .btn-evolve {
            background: linear-gradient(135deg, #9f7aea, #b794f6);
            color: white;
            grid-column: 1 / -1;
            font-size: 18px;
            padding: 20px;
        }

        .btn-evolve:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        /* === CREATE PET MODAL === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .variant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .variant-option {
            text-align: center;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .variant-option:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .variant-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .variant-option img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        /* === LOADING SPINNER === */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .login-card {
                padding: 30px 20px;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .pets-grid {
                grid-template-columns: 1fr;
            }

            .pet-detail-card {
                padding: 30px 20px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .actions-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* === NOTIFICATIONS === */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #48bb78;
            color: white;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 2000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #e53e3e;
        }
    </style>
</head>
<body>
<!-- LOGIN/REGISTER SCREEN -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <h1>üê≤ Virtual Pet</h1>

        <!-- Login Form -->
        <div id="loginForm">
            <div class="form-group">
                <label for="loginUsername">Usuario</label>
                <input type="text" id="loginUsername" placeholder="Insert your username">
            </div>
            <div class="form-group">
                <label for="loginPassword">Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="Insert your password">
            </div>
            <button class="btn" onclick="login()">
                <span class="btn-text">Login</span>
                <span class="loading" style="display: none;"></span>
            </button>
            <button class="btn btn-secondary" onclick="showRegister()">
                ¬øDon't have an account? Create one
            </button>
        </div>

        <!-- Register Form -->
        <div id="registerForm" style="display: none;">
            <div class="form-group">
                <label for="registerUsername">Usuario</label>
                <input type="text" id="registerUsername" placeholder="Username">
            </div>
            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label for="registerPassword">Contrase√±a</label>
                <input type="password" id="registerPassword" placeholder="6 chars min">
            </div>
            <button class="btn" onclick="register()">
                <span class="btn-text">Crear Cuenta</span>
                <span class="loading" style="display: none;"></span>
            </button>
            <button class="btn btn-secondary" onclick="showLogin()">
                ¬øHave an account? Login
            </button>
        </div>
    </div>
</div>

<!-- DASHBOARD SCREEN -->
<div id="dashboardScreen" class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <h1>My pets</h1>
            <div class="user-info">
                <span id="welcomeUser">¬°Welcome, User!</span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="pets-grid" id="petsGrid">
            <!-- Create New Pet Card -->
            <div class="pet-card create-pet-card" onclick="showCreatePetModal()">
                <div class="create-icon">+</div>
                <h3>Create new pet</h3>
                <p>¬°Start your adventure!</p>
            </div>

            <!-- Pet cards will be loaded here -->
        </div>
    </div>
</div>

<!-- PET DETAIL SCREEN -->
<div id="petDetailScreen" class="pet-detail">
    <div class="container">
        <div class="pet-detail-card">
            <div class="pet-detail-header">
                <button class="back-btn" onclick="showDashboard()">‚Üê Back</button>
                <h2>Pet details</h2>
            </div>

            <div class="pet-detail-image" id="petDetailImage">
                <img src="images/pets/dragon-mountain-egg.png" alt="Pet" id="petDetailImg">
            </div>

            <h2 class="pet-name" id="petDetailName">Pet's name</h2>
            <p class="pet-stage" id="petDetailStage">Stage ‚Ä¢ Variant</p>

            <div class="stats-container">
                <div class="stat-bar stat-energy">
                    <div class="stat-label">
                        <span>‚ö° Energy</span>
                        <span id="energyValue">50/100</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill" id="energyBar" style="width: 50%"></div>
                    </div>
                </div>

                <div class="stat-bar stat-happiness">
                    <div class="stat-label">
                        <span>üòä Happiness</span>
                        <span id="happinessValue">50/100</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill" id="happinessBar" style="width: 50%"></div>
                    </div>
                </div>

                <div class="stat-bar stat-hunger">
                    <div class="stat-label">
                        <span>üçñ Hunger</span>
                        <span id="hungerValue">50/100</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill" id="hungerBar" style="width: 50%"></div>
                    </div>
                </div>

                <div class="stat-bar stat-experience">
                    <div class="stat-label">
                        <span>‚≠ê Experience</span>
                        <span id="experienceValue">0/10</span>
                    </div>
                    <div class="stat-progress">
                        <div class="stat-fill" id="experienceBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="actions-container">
                <button class="action-btn btn-feed" onclick="performAction('feed')">
                    üçñ Feed
                </button>
                <button class="action-btn btn-play" onclick="performAction('play')">
                    üéæ Play
                </button>
                <button class="action-btn btn-rest" onclick="performAction('rest')">
                    üí§ Rest
                </button>
                <button class="action-btn btn-ignore" onclick="performAction('ignore')">
                    üö´ Ignore
                </button>
                <button class="action-btn btn-evolve" id="evolveBtn" onclick="performAction('evolve')" disabled>
                    ‚ú® ¬°EVOLVE!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- CREATE PET MODAL -->
<div id="createPetModal" class="modal">
    <div class="modal-content">
        <h2>Create new pet</h2>

        <div class="form-group">
            <label for="petName">Pet's name</label>
            <input type="text" id="petName" placeholder="Ej: Draco, Aqua, Terra...">
        </div>

        <h3>Choose a variant:</h3>
        <div class="variant-grid">
            <div class="variant-option" onclick="selectVariant('MOUNTAIN')">
                <img src="images/pets/dragon-mountain-egg.png" alt="Mountain Dragon">
                <p>Mountain</p>
            </div>
            <div class="variant-option" onclick="selectVariant('SWAMP')">
                <img src="images/pets/dragon-swamp-egg.png" alt="Swamp Dragon">
                <p>Swamp</p>
            </div>
            <div class="variant-option" onclick="selectVariant('FOREST')">
                <img src="images/pets/dragon-forest-egg.png" alt="Forest Dragon">
                <p>Forest</p>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button class="btn" onclick="createPet()" id="createPetBtn" disabled>
                <span class="btn-text">Create pet</span>
                <span class="loading" style="display: none;"></span>
            </button>
            <button class="btn btn-secondary" onclick="closeCreatePetModal()">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- NOTIFICATION -->
<div id="notification" class="notification">
    <span id="notificationText"></span>
</div>

<script>
    // === GLOBAL VARIABLES ===
    let currentUser = null;
    let currentPet = null;
    let selectedVariant = null;
    const API_BASE_URL = 'http://localhost:8080/api';

    // === UTILITY FUNCTIONS ===
    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        const notificationText = document.getElementById('notificationText');

        notificationText.textContent = message;
        notification.className = `notification ${isError ? 'error' : ''} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function setLoading(buttonId, isLoading) {
        const button = document.getElementById(buttonId) || event.target;
        const btnText = button.querySelector('.btn-text');
        const loading = button.querySelector('.loading');

        if (isLoading) {
            btnText.style.display = 'none';
            loading.style.display = 'inline-block';
            button.disabled = true;
        } else {
            btnText.style.display = 'inline';
            loading.style.display = 'none';
            button.disabled = false;
        }
    }

    // === API FUNCTIONS ===
    async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
            }
        };

        if (currentUser && currentUser.token) {
            options.headers['Authorization'] = `Bearer ${currentUser.token}`;
        }

        if (data) {
            options.body = JSON.stringify(data);
        }

        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Error en la petici√≥n');
            }

            return result;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // === AUTH FUNCTIONS ===
    function showLogin() {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
    }

    function showRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }

    async function login() {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            showNotification('Please, insert username and password', true);
            return;
        }

        setLoading('loginForm', true);

        try {
            const response = await apiCall('/auth/login', 'POST', {
                username,
                password
            });

            currentUser = response.data;
            localStorage.setItem('virtualPetUser', JSON.stringify(currentUser));

            showNotification('¬°Welcome back!');
            showDashboard();
        } catch (error) {
            showNotification(error.message, true);
        } finally {
            setLoading('loginForm', false);
        }
    }

    async function register() {
        const username = document.getElementById('registerUsername').value;
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;

        if (!username || !email || !password) {
            showNotification('Please, complete all fields', true);
            return;
        }

        if (password.length < 6) {
            showNotification('Password must be 6 chars min', true);
            return;
        }

        setLoading('registerForm', true);

        try {
            await apiCall('/auth/register', 'POST', {
                username,
                email,
                password
            });

            showNotification('¬°Account created! You can login');
            showLogin();
        } catch (error) {
            showNotification(error.message, true);
        } finally {
            setLoading('registerForm', false);
        }
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('virtualPetUser');
        showLoginScreen();
        showNotification('Logout');
    }

    // === SCREEN FUNCTIONS ===
    function showLoginScreen() {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('dashboardScreen').classList.remove('active');
        document.getElementById('petDetailScreen').classList.remove('active');
    }

    function showDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('dashboardScreen').classList.add('active');
        document.getElementById('petDetailScreen').classList.remove('active');

        if (currentUser) {
            document.getElementById('welcomeUser').textContent = `¬°Hi, ${currentUser.username}!`;
            loadUserPets();
        }
    }

    function showPetDetail(pet) {
        currentPet = pet;
        document.getElementById('dashboardScreen').classList.remove('active');
        document.getElementById('petDetailScreen').classList.add('active');

        updatePetDetailDisplay();
    }

    // === PET FUNCTIONS ===
    async function loadUserPets() {
        try {
            const response = await apiCall('/pets');
            const pets = response.data;

            displayPets(pets);
        } catch (error) {
            showNotification('Cannot load pet list', true);
        }
    }

    function displayPets(pets) {
        const petsGrid = document.getElementById('petsGrid');
        const createCard = petsGrid.querySelector('.create-pet-card');

        // Clear existing pet cards but keep create card
        petsGrid.innerHTML = '';
        petsGrid.appendChild(createCard);

        pets.forEach(pet => {
            const petCard = createPetCard(pet);
            petsGrid.appendChild(petCard);
        });
    }

    function createPetCard(pet) {
        const card = document.createElement('div');
        card.className = 'pet-card';
        card.onclick = () => showPetDetail(pet);

        const imagePath = getPetImagePath(pet.variant, pet.stage);

        card.innerHTML = `
            <div class="pet-image">
                <img src="${imagePath}" alt="${pet.name}" onerror="this.src='images/pets/default.png'">
            </div>
            <div class="pet-info">
                <h3>${pet.name}</h3>
                <p>${pet.stage} ‚Ä¢ ${pet.variant}</p>
                <div class="pet-stats">
                    <span>‚ö° ${pet.energy}</span>
                    <span>üòä ${pet.happiness}</span>
                    <span>üçñ ${100 - pet.hunger}</span>
                    <span>‚≠ê ${pet.experience}</span>
                </div>
            </div>
        `;

        return card;
    }

    function getPetImagePath(variant, stage) {
        const variantName = variant.toLowerCase();
        const stageName = stage.toLowerCase();
        return `images/pets/dragon-${variantName}-${stageName}.png`;
    }

    function updatePetDetailDisplay() {
        if (!currentPet) return;

        // Update pet image
        const petImg = document.getElementById('petDetailImg');
        petImg.src = getPetImagePath(currentPet.variant, currentPet.stage);
        petImg.alt = currentPet.name;

        // Update pet info
        document.getElementById('petDetailName').textContent = currentPet.name;
        document.getElementById('petDetailStage').textContent = `${currentPet.stage} ‚Ä¢ ${currentPet.variant}`;

        // Update stats
        updateStatBar('energy', currentPet.energy);
        updateStatBar('happiness', currentPet.happiness);
        updateStatBar('hunger', 100 - currentPet.hunger); // Inverse hunger (full = good)
        updateStatBar('experience', currentPet.experience);

        // Update evolve button
        const evolveBtn = document.getElementById('evolveBtn');
        const canEvolve = checkCanEvolve(currentPet);
        evolveBtn.disabled = !canEvolve;

        if (canEvolve) {
            evolveBtn.textContent = '‚ú® ¬°EVOLUTION AVAILABLE!';
            evolveBtn.style.animation = 'pulse 2s infinite';
        } else {
            evolveBtn.textContent = '‚ú® Evolve (No disponible)';
            evolveBtn.style.animation = 'none';
        }
    }

    function updateStatBar(statName, value) {
        const maxValue = statName === 'experience' ? 100 : 100; // You can adjust max values
        const percentage = Math.max(0, Math.min(100, (value / maxValue) * 100));

        document.getElementById(`${statName}Value`).textContent = `${value}/${maxValue}`;
        document.getElementById(`${statName}Bar`).style.width = `${percentage}%`;
    }

    function checkCanEvolve(pet) {
        // Define evolution requirements
        const requirements = {
            EGG: { experience: 50, energy: 70 },
            YOUNG: { experience: 100, energy: 80 },
            ADULT: null // Can't evolve further
        };

        const req = requirements[pet.stage];
        if (!req) return false;

        return pet.experience >= req.experience && pet.energy >= req.energy;
    }

    async function performAction(action) {
        if (!currentPet) return;

        const actionButton = event.target;
        const originalText = actionButton.textContent;

        try {
            actionButton.disabled = true;
            actionButton.textContent = '‚è≥ Processing...';

            const response = await apiCall(`/pets/${currentPet.id}/${action}`, 'POST');
            const updatedPet = response.data;

            // Update current pet data
            currentPet = updatedPet;
            updatePetDetailDisplay();

            // Show success message
            const messages = {
                feed: 'üçñ ¬°Your pet has eaten and is happier!',
                play: 'üéæ ¬°You have played together! Guaranteed fun.',
                rest: 'üí§ Your pet has rested and regained energy.',
                ignore: 'üòî You have ignored your pet...',
                evolve: '‚ú® INCREDIBLE! Your pet has evolved!'
            };

            showNotification(messages[action] || '‚úÖ Action complete');

            // Special handling for evolution
            if (action === 'evolve') {
                setTimeout(() => {
                    showNotification(`üéâ ¬°${currentPet.name} now is ${currentPet.stage}!`);
                }, 1500);
            }

        } catch (error) {
            showNotification(error.message, true);
        } finally {
            actionButton.disabled = false;
            actionButton.textContent = originalText;
        }
    }

    // === CREATE PET MODAL ===
    function showCreatePetModal() {
        document.getElementById('createPetModal').classList.add('active');
        document.getElementById('petName').value = '';
        selectedVariant = null;

        // Reset variant selection
        document.querySelectorAll('.variant-option').forEach(option => {
            option.classList.remove('selected');
        });

        document.getElementById('createPetBtn').disabled = true;
    }

    function closeCreatePetModal() {
        document.getElementById('createPetModal').classList.remove('active');
    }

    function selectVariant(variant) {
        selectedVariant = variant;

        // Update visual selection
        document.querySelectorAll('.variant-option').forEach(option => {
            option.classList.remove('selected');
        });

        event.currentTarget.classList.add('selected');

        // Check if we can enable create button
        const petName = document.getElementById('petName').value.trim();
        document.getElementById('createPetBtn').disabled = !petName || !selectedVariant;
    }

    // Enable create button when name is entered
    document.addEventListener('DOMContentLoaded', function() {
        const petNameInput = document.getElementById('petName');
        if (petNameInput) {
            petNameInput.addEventListener('input', function() {
                const petName = this.value.trim();
                document.getElementById('createPetBtn').disabled = !petName || !selectedVariant;
            });
        }
    });

    async function createPet() {
        const petName = document.getElementById('petName').value.trim();

        if (!petName || !selectedVariant) {
            showNotification('Por favor, completa todos los campos', true);
            return;
        }

        setLoading('createPetBtn', true);

        try {
            const response = await apiCall('/pets', 'POST', {
                name: petName,
                variant: selectedVariant
            });

            showNotification(`¬°${petName} has borne! ü•ö‚ú®`);
            closeCreatePetModal();
            loadUserPets(); // Refresh pets list

        } catch (error) {
            showNotification(error.message, true);
        } finally {
            setLoading('createPetBtn', false);
        }
    }

    // === KEYBOARD SHORTCUTS ===
    document.addEventListener('keydown', function(event) {
        // Close modal with Escape
        if (event.key === 'Escape') {
            closeCreatePetModal();
        }

        // Submit forms with Enter
        if (event.key === 'Enter') {
            const activeElement = document.activeElement;

            if (activeElement.closest('#loginForm')) {
                login();
            } else if (activeElement.closest('#registerForm')) {
                register();
            } else if (activeElement.closest('#createPetModal')) {
                if (!document.getElementById('createPetBtn').disabled) {
                    createPet();
                }
            }
        }
    });

    // === AUTO-LOGIN CHECK ===
    function checkAutoLogin() {
        const savedUser = localStorage.getItem('virtualPetUser');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            } catch (error) {
                localStorage.removeItem('virtualPetUser');
                showLoginScreen();
            }
        } else {
            showLoginScreen();
        }
    }

    // === PERIODIC PET STATUS UPDATE ===
    function startPetStatusUpdater() {
        setInterval(() => {
            if (currentPet && document.getElementById('petDetailScreen').classList.contains('active')) {
                // Simulate gradual stat changes over time
                simulatePetNeeds();
            }
        }, 30000); // Every 30 seconds
    }

    function simulatePetNeeds() {
        if (!currentPet) return;

        // Gradually decrease some stats over time (simulate needs)
        const changes = {
            energy: -1,
            happiness: -0.5,
            hunger: +1 // Hunger increases (gets hungrier)
        };

        let hasChanges = false;

        for (const [stat, change] of Object.entries(changes)) {
            const newValue = Math.max(0, Math.min(100, currentPet[stat] + change));
            if (newValue !== currentPet[stat]) {
                currentPet[stat] = newValue;
                hasChanges = true;
            }
        }

        if (hasChanges) {
            updatePetDetailDisplay();

            // Show need notifications
            if (currentPet.energy < 20) {
                showNotification('‚ö° Your pet is tired', true);
            } else if (currentPet.happiness < 30) {
                showNotification('üò¢ Your pet is sad', true);
            } else if (currentPet.hunger > 80) {
                showNotification('üçñ Your pet wants to eat', true);
            }
        }
    }

    // === ADD PULSE ANIMATION FOR EVOLVE BUTTON ===
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(159, 122, 234, 0.5); }
            100% { transform: scale(1); }
        }

        .btn-evolve:not(:disabled):hover {
            box-shadow: 0 0 30px rgba(159, 122, 234, 0.7) !important;
        }
    `;
    document.head.appendChild(style);

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
        checkAutoLogin();
        startPetStatusUpdater();

        // Add click outside modal to close
        document.getElementById('createPetModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeCreatePetModal();
            }
        });
    });

    // === ERROR HANDLING FOR IMAGES ===
    document.addEventListener('error', function(event) {
        if (event.target.tagName === 'IMG') {
            event.target.src = 'images/pets/default.png';
        }
    }, true);

    // === TOUCH SUPPORT FOR MOBILE ===
    let touchStartY = 0;
    document.addEventListener('touchstart', function(event) {
        touchStartY = event.touches[0].clientY;
    });

    document.addEventListener('touchmove', function(event) {
        const touchY = event.touches[0].clientY;
        const touchDiff = touchStartY - touchY;

        // Prevent bounce on iOS when scrolling
        if (document.body.scrollTop === 0 && touchDiff < 0) {
            event.preventDefault();
        }
    });
</script>
</body>
</html>